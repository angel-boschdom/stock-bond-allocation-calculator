<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Retirement Simulation</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/9.4.4/math.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="./uicomponents/RadioButtonCustom.js"></script>
    <link rel="stylesheet" href="./uicomponents/RadioButtonCustom.css">
    <style>
        #progress-container {
            width: 100%;
            background-color: #f3f3f3;
            margin-top: 20px;
        }

        #progress-bar {
            width: 0%;
            height: 30px;
            background-color: #4caf50;
            text-align: center;
            line-height: 30px;
            color: white;
        }
    </style>
</head>
<body>
    <h1>Calculate Probability of Success in Retirement</h1>

    <label for="years">Years: </label>
    <div class="radio-button-custom" id="yearsRadio"></div>

    <label for="retirementYear">Retirement year: </label>
    <div class="radio-button-custom" id="retirementYearRadio"></div>

    <label for="initialNetWorth">Initial Net Worth: </label>
    <div class="radio-button-custom" id="initialNetWorthRadio"></div>

    <label for="monthlySalary">Monthly Salary: </label>
    <div class="radio-button-custom" id="monthlySalaryRadio"></div>

    <label for="monthlyExpenses">Monthly Expenses: </label>
    <div class="radio-button-custom" id="monthlyExpensesRadio"></div>

    <label for="netWorthThreshold">Net Worth Threshold: </label>
    <div class="radio-button-custom" id="netWorthThresholdRadio"></div>

    <label for="bondReturn">Bond Return: </label>
    <div class="radio-button-custom" id="bondReturnRadio"></div>

    <label for="stockMeanReturn">Stock Mean Return: </label>
    <div class="radio-button-custom" id="stockMeanReturnRadio"></div>

    <label for="stockStdDev">Stock Standard Deviation: </label>
    <div class="radio-button-custom" id="stockStdDevRadio"></div>

    <label for="simulations">Number of Simulations: </label>
    <div class="radio-button-custom" id="simulationsRadio"></div>

    <button id="calculateButton">Calculate</button>

    <div id="progress-container">
        <div id="progress-bar">0%</</div>
    </div>

    <div id="plot"></div>
    <script>
        const radioButtonInstances = {}; // Global object to hold RadioButtonCustom instances

        // Create the radio groups
        getOrCreateRadioButtonCustom('yearsRadio', [40, 50, 60], 2);
        getOrCreateRadioButtonCustom('retirementYearRadio', [20, 25, 30], 2);
        getOrCreateRadioButtonCustom('initialNetWorthRadio', [200000, 300000, 400000], 1);
        getOrCreateRadioButtonCustom('monthlySalaryRadio', [5000, 5800, 7000], 1);
        getOrCreateRadioButtonCustom('monthlyExpensesRadio', [2000, 3000, 4000], 2);
        getOrCreateRadioButtonCustom('netWorthThresholdRadio', [400e3, 500e3, 600e3], 1);
        getOrCreateRadioButtonCustom('bondReturnRadio', [0.01, 0.02, 0.03], 2);
        getOrCreateRadioButtonCustom('stockMeanReturnRadio', [0.07, 0.09, 0.11], 2);
        getOrCreateRadioButtonCustom('stockStdDevRadio', [0.15, 0.19, 0.23], 1);
        getOrCreateRadioButtonCustom('simulationsRadio', [5000, 10000, 20000], 1);

        // Function to get or create a RadioButtonCustom instance
        function getOrCreateRadioButtonCustom(key, options, defaultIndex) {
            if (!radioButtonInstances[key]) {
                radioButtonInstances[key] = new RadioButtonCustom(key, options, defaultIndex);
            }
            return radioButtonInstances[key];
        }

        async function calculateAndPlot() {
            // Retrieve or create RadioButtonCustom objects for parameters
            const yearsRadio = getOrCreateRadioButtonCustom('yearsRadio', [40, 50, 60], 2);
            const retirementYearRadio = getOrCreateRadioButtonCustom('retirementYearRadio', [20, 25, 30], 2);
            const initialNetWorthRadio = getOrCreateRadioButtonCustom('initialNetWorthRadio', [200000, 300000, 400000], 1);
            const monthlySalaryRadio = getOrCreateRadioButtonCustom('monthlySalaryRadio', [5000, 5800, 7000], 1);
            const monthlyExpensesRadio = getOrCreateRadioButtonCustom('monthlyExpensesRadio', [2000, 3000, 4000], 1);
            const netWorthThresholdRadio = getOrCreateRadioButtonCustom('netWorthThresholdRadio', [400e3, 500e3, 600e3], 1);
            const bondReturnRadio = getOrCreateRadioButtonCustom('bondReturnRadio', [0.01, 0.02, 0.03], 0);
            const stockMeanReturnRadio = getOrCreateRadioButtonCustom('stockMeanReturnRadio', [0.07, 0.09, 0.11], 1);
            const stockStdDevRadio = getOrCreateRadioButtonCustom('stockStdDevRadio', [0.15, 0.19, 0.23], 1);
            const simulationsRadio = getOrCreateRadioButtonCustom('simulationsRadio', [5000, 10000, 20000], 1);

            const parameters = {
                years: parseInt(yearsRadio.getValue()),
                retirementYear: parseInt(retirementYearRadio.getValue()),
                initialNetWorth: parseInt(initialNetWorthRadio.getValue()),
                annualSalary: parseInt(monthlySalaryRadio.getValue())*12,
                annualExpenses: parseInt(monthlyExpensesRadio.getValue())*12,
                netWorthThreshold: parseInt(netWorthThresholdRadio.getValue()),
                bondReturn: parseFloat(bondReturnRadio.getValue()),
                stockMeanReturn: parseFloat(stockMeanReturnRadio.getValue()),
                stockStdDev: parseFloat(stockStdDevRadio.getValue()),
                simulations: parseInt(simulationsRadio.getValue())
            };

            const puStock2BondFirstThresholdVals = math.range(1.5, 2, 0.05).toArray();
            const puStock2BondSecondThresholdVals = math.range(2.5, 4, 0.1).toArray();
            let probVals = [];
            let totalIterations = puStock2BondFirstThresholdVals.length * puStock2BondSecondThresholdVals.length;
            let iteration = 0;

            for (let idxFirst = puStock2BondFirstThresholdVals.length - 1; idxFirst >= 0; idxFirst--) {
                probVals[idxFirst] = [];
                for (let idxSecond = puStock2BondSecondThresholdVals.length - 1; idxSecond >= 0; idxSecond--) {
                    let puStock2BondThreshold = [puStock2BondFirstThresholdVals[idxFirst], puStock2BondSecondThresholdVals[idxSecond]];
                    probVals[idxFirst][idxSecond] = computeProbabilityOfSuccessWithThreeAllocations(puStock2BondThreshold, parameters);

                    // Update progress bar
                    iteration++;
                    let progress = Math.floor((iteration / totalIterations) * 100);
                    document.getElementById('progress-bar').style.width = progress + '%';
                    document.getElementById('progress-bar').innerText = progress + '%';

                    // Allow the UI to update
                    await new Promise(resolve => setTimeout(resolve, 0));
                }
            }

            let data = [{
                x: puStock2BondFirstThresholdVals,
                y: puStock2BondSecondThresholdVals,
                z: probVals,
                type: 'surface'
            }];

            let layout = {
                title: 'Probability of Success with Three Allocations',
                scene: {
                    xaxis: {title: 'First threshold'},
                    yaxis: {title: 'Second threshold'},
                    zaxis: {title: 'Probability'}
                }
            };

            Plotly.newPlot('plot', data, layout);
        }

        document.getElementById('calculateButton').addEventListener('click', calculateAndPlot);

        function gaussianRandom(mean, stdev) {
            let u = 1 - Math.random(); // Converting [0,1) to (0,1]
            let v = Math.random();
            let z = Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
            return z * stdev + mean;
        }

        function computeProbabilityOfSuccessWithConstantAllocation(stockAllocation, params) {
            let successfulOutcomes = 0;
            let bondAllocation = 1 - stockAllocation;

            for (let sim = 0; sim < params.simulations; sim++) {
                let netWorth = params.initialNetWorth;
                for (let year = 0; year < params.years; year++) {
                    let stockReturn = gaussianRandom(params.stockMeanReturn, params.stockStdDev);
                    if (year < params.retirementYear) {
                        netWorth += params.annualSalary - params.annualExpenses;
                    } else {
                        netWorth -= params.annualExpenses;
                    }
                    if (netWorth < 0) {
                        netWorth *= 1.30; // assume 30% yearly interest debt on credit card
                    } else {
                        netWorth *= (1 + stockAllocation * stockReturn + bondAllocation * params.bondReturn);
                    }
                }
                if (netWorth >= params.netWorthThreshold) {
                    successfulOutcomes++;
                }
            }
            return successfulOutcomes / params.simulations;
        }

        function computeProbabilityOfSuccessWithThreeAllocations(puStock2BondThreshold, params) {
            let successfulOutcomes = 0;

            for (let sim = 0; sim < params.simulations; sim++) {
                let netWorth = params.initialNetWorth;
                for (let year = 0; year < params.years; year++) {
                    let stockAllocation;
                    if (netWorth < puStock2BondThreshold[0] * params.netWorthThreshold) {
                        stockAllocation = 1; // all stocks
                    } else if (netWorth < puStock2BondThreshold[1] * params.netWorthThreshold) {
                        stockAllocation = 0.5; // 50-50
                    } else {
                        stockAllocation = 0; // all bonds
                    }
                    let bondAllocation = 1 - stockAllocation;
                    let stockReturn = gaussianRandom(params.stockMeanReturn, params.stockStdDev);

                    if (year < params.retirementYear) {
                        netWorth += params.annualSalary - params.annualExpenses;
                    } else {
                        netWorth -= params.annualExpenses;
                    }
                    if (netWorth < 0) {
                        netWorth *= 1.30; // assume 30% yearly interest debt on credit card
                    } else {
                        netWorth *= (1 + stockAllocation * stockReturn + bondAllocation * params.bondReturn);
                    }
                }
                if (netWorth >= params.netWorthThreshold) {
                    successfulOutcomes++;
                }
            }
            return successfulOutcomes / params.simulations;
        }
    </script>
</body>
</html>